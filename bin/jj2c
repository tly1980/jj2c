#!/usr/bin/env python

from __future__ import print_function

import argparse
import json
import os
import sys

import yaml
from jj2c import eprint
import jj2c

AP = argparse.ArgumentParser()
AP.add_argument('template', help='file pointing to template')
AP.add_argument(
    '-V', '--variables', default=[],
    nargs='+', help='Content or files pointing to variables. Supported formats are: json, yaml and toml.')
AP.add_argument('-o', '--output', default='-', help='where to save the file')
AP.add_argument('-i', '--inspect', action='store_true', default=False, help='Inspect parameters')


def is_tpl(fpath):
  msg = 'No such *FILE*: %s' % fpath
  if os.path.isdir(fpath):
    return False
  if not os.path.isfile(fpath):
    raise Exception(msg)
  return not fpath.endswith('.zip')


def load_variables(fname_or_content):
  ve = jj2c.VariableExtractor(fname_or_content)
  fmt, variables = ve.extract()
  return variables


def dump_file(fpath, content):
  if fpath == '-':
    sys.stdout.write(content)
    sys.stdout.flush()
  else:
    with open(fpath, 'w') as f:
      f.write(content)


def main(args):
  variables = {}
  for file_or_content in args.variables:
    if args.inspect:
      eprint('Parsing variables from: {}'.format(file_or_content))
    x_variables = load_variables(file_or_content)
    if args.inspect:
      eprint(yaml.dump(x_variables))
      eprint('-----\n')
    variables.update(x_variables)

  template_path = args.template
  if template_path.endswith('/'):
    template_path = template_path[:-1]

  path_info = 'src: {}\ndest:{}'.format(template_path, args.output)

  if os.path.isdir(template_path):
    if args.output.endswith('.zip'):
      eprint('Compiling... tpl(dir) to zip')
      eprint(path_info)
      jj2c.compile_dir_2_zip(template_path, args.output, variables)
    else:
      eprint('Compiling... tpl(dir) to dir')
      eprint(path_info)
      jj2c.compile_dir(template_path, args.output, variables)
  elif template_path.endswith('.zip'):
    if args.output.endswith('.zip'):
      eprint('Compiling... tpl(zip) to zip')
      eprint(path_info)
      jj2c.compile_zip_2_zip(template_path, args.output, variables)
    else:
      eprint('Compiling... tpl(zip) to dir')
      eprint(path_info)
      jj2c.compile_zip_2_dir(template_path, args.output, variables)
  elif is_tpl(template_path):
    with open(template_path) as f:
      eprint('Compiling... tpl(zip) to stdout')
      eprint(path_info)
      dump_file(args.output, jj2c.compile(f.read(), variables))
  else:
    eprint('Path info:', path_info)
    print('Unsupported')


if __name__ == '__main__':
  main(AP.parse_args())
